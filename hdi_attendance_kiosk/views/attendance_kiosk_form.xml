<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Systray Attendance Kiosk Form View -->
    <record id="view_attendance_kiosk_form" model="ir.ui.view">
        <field name="name">Attendance Kiosk Form</field>
        <field name="model">hr.attendance</field>
        <field name="arch" type="xml">
            <form string="Chấm Công" create="false" delete="false" edit="false">
                <sheet>
                    <div class="kiosk-container" style="text-align: center; padding: 40px;">
                        <!-- Header -->
                        <h1 class="kiosk-title" style="font-size: 32px; margin-bottom: 20px; color: #333;">
                            Chấm Công Điện Tử
                        </h1>
                        
                        <!-- Current Time -->
                        <div id="current-time-display" style="font-size: 48px; color: #667eea; font-weight: bold; margin-bottom: 30px; font-family: 'Courier New';">
                            <span id="clock-display">--:--:--</span>
                        </div>

                        <!-- Employee Info Card -->
                        <div style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px; padding: 30px; margin-bottom: 30px;">
                            <h2 id="employee-name-display" style="font-size: 24px; color: #333; margin-bottom: 10px;">
                                Loading...
                            </h2>
                            <div id="status-message-display" style="font-size: 16px; color: #666; font-weight: 500;"></div>

                            <!-- Status Details -->
                            <div style="background: white; border-radius: 10px; padding: 20px; margin-top: 20px;">
                                <div id="check-in-detail" style="display: none; padding: 10px 0; border-bottom: 1px solid #eee;">
                                    <span style="font-weight: 600; color: #555;">Check-in: </span>
                                    <span id="check-in-time-display" style="color: #667eea; font-weight: 700;"></span>
                                </div>
                                <div id="check-out-detail" style="display: none; padding: 10px 0; border-bottom: 1px solid #eee;">
                                    <span style="font-weight: 600; color: #555;">Check-out: </span>
                                    <span id="check-out-time-display" style="color: #667eea; font-weight: 700;"></span>
                                </div>
                                <div id="worked-hours-detail" style="display: none; padding: 10px 0; border-bottom: 1px solid #eee;">
                                    <span style="font-weight: 600; color: #555;">Giờ làm việc: </span>
                                    <span id="worked-hours-display" style="color: #667eea; font-weight: 700;"></span>
                                </div>
                                <div style="padding: 10px 0;">
                                    <span style="font-weight: 600; color: #555;">Hôm nay: </span>
                                    <span id="today-hours-display" style="color: #27ae60; font-weight: 700; font-size: 18px;">0 giờ</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                            <button type="button" id="check-in-btn-kiosk" class="btn btn-primary" onclick="performCheckIn()" style="padding: 18px; font-size: 16px; font-weight: 600;">
                                <i class="fa fa-sign-in" style="margin-right: 8px;"></i>Check-in
                            </button>
                            <button type="button" id="check-out-btn-kiosk" class="btn btn-danger" onclick="performCheckOut()" disabled="disabled" style="padding: 18px; font-size: 16px; font-weight: 600; opacity: 0.5;">
                                <i class="fa fa-sign-out" style="margin-right: 8px;"></i>Check-out
                            </button>
                        </div>

                        <!-- Result Message -->
                        <div id="result-message-kiosk" style="display: none; padding: 15px 20px; border-radius: 10px; text-align: center; font-weight: 600; margin-top: 20px;"></div>
                    </div>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Action Window cho Kiosk -->
    <record id="action_attendance_kiosk_form" model="ir.actions.act_window">
        <field name="name">Chấm Công</field>
        <field name="res_model">hr.attendance</field>
        <field name="view_mode">form</field>
        <field name="views">[(id(view_attendance_kiosk_form), 'form')]</field>
        <field name="target">fullscreen</field>
        <field name="context">{}</field>
    </record>

    <script>
        // JavaScript cho Kiosk form view
        function initKioskClock() {
            function updateClock() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('vi-VN');
                const clockDisplay = document.getElementById('clock-display');
                if (clockDisplay) {
                    clockDisplay.textContent = timeStr;
                }
            }
            updateClock();
            setInterval(updateClock, 1000);
        }

        async function loadKioskStatus() {
            try {
                const response = await fetch('/kiosk/api/status', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    updateKioskStatusUI(data);
                    updateKioskWorkedHours();
                    setTimeout(loadKioskStatus, 5000);
                }
            } catch (error) {
                console.error('Error loading status:', error);
            }
        }

        function updateKioskStatusUI(status) {
            const nameEl = document.getElementById('employee-name-display');
            const msgEl = document.getElementById('status-message-display');
            const checkInBtn = document.getElementById('check-in-btn-kiosk');
            const checkOutBtn = document.getElementById('check-out-btn-kiosk');

            nameEl.textContent = status.employee_name || 'Loading...';
            msgEl.textContent = status.message || '';

            document.getElementById('check-in-detail').style.display = 'none';
            document.getElementById('check-out-detail').style.display = 'none';
            document.getElementById('worked-hours-detail').style.display = 'none';

            if (status.status === 'not_checked_in') {
                checkInBtn.disabled = false;
                checkOutBtn.disabled = true;
                checkInBtn.style.opacity = '1';
                checkOutBtn.style.opacity = '0.5';
            } else if (status.status === 'checked_in') {
                checkInBtn.disabled = true;
                checkOutBtn.disabled = false;
                checkInBtn.style.opacity = '0.5';
                checkOutBtn.style.opacity = '1';

                document.getElementById('check-in-detail').style.display = 'block';
                document.getElementById('check-in-time-display').textContent = 
                    new Date(status.check_in_time).toLocaleTimeString('vi-VN');
            } else if (status.status === 'checked_out') {
                checkInBtn.disabled = false;
                checkOutBtn.disabled = true;
                checkInBtn.style.opacity = '1';
                checkOutBtn.style.opacity = '0.5';

                document.getElementById('check-in-detail').style.display = 'block';
                document.getElementById('check-out-detail').style.display = 'block';
                document.getElementById('worked-hours-detail').style.display = 'block';

                document.getElementById('check-in-time-display').textContent = 
                    new Date(status.check_in_time).toLocaleTimeString('vi-VN');
                document.getElementById('check-out-time-display').textContent = 
                    new Date(status.check_out_time).toLocaleTimeString('vi-VN');
                document.getElementById('worked-hours-display').textContent = 
                    status.worked_hours + ' giờ';
            }
        }

        async function updateKioskWorkedHours() {
            try {
                const response = await fetch('/kiosk/api/today-worked-hours', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await response.json();
                if (data.success) {
                    document.getElementById('today-hours-display').textContent = 
                        data.total_worked_hours.toFixed(1) + ' giờ';
                }
            } catch (error) {
                console.error('Error updating hours:', error);
            }
        }

        async function performCheckIn() {
            try {
                const btn = document.getElementById('check-in-btn-kiosk');
                btn.disabled = true;

                const payload = {};
                if (navigator.geolocation) {
                    await new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                payload.in_latitude = pos.coords.latitude;
                                payload.in_longitude = pos.coords.longitude;
                                resolve();
                            },
                            () => resolve()
                        );
                    });
                }

                const response = await fetch('/kiosk/api/check-in', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                showKioskMessage(data.message, data.success);

                if (data.success) {
                    setTimeout(loadKioskStatus, 500);
                } else {
                    btn.disabled = false;
                }
            } catch (error) {
                showKioskMessage('Lỗi: ' + error.message, false);
                document.getElementById('check-in-btn-kiosk').disabled = false;
            }
        }

        async function performCheckOut() {
            try {
                const btn = document.getElementById('check-out-btn-kiosk');
                btn.disabled = true;

                const payload = {};
                if (navigator.geolocation) {
                    await new Promise((resolve) => {
                        navigator.geolocation.getCurrentPosition(
                            (pos) => {
                                payload.out_latitude = pos.coords.latitude;
                                payload.out_longitude = pos.coords.longitude;
                                resolve();
                            },
                            () => resolve()
                        );
                    });
                }

                const response = await fetch('/kiosk/api/check-out', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                showKioskMessage(data.message, data.success);

                if (data.success) {
                    setTimeout(loadKioskStatus, 500);
                } else {
                    btn.disabled = false;
                }
            } catch (error) {
                showKioskMessage('Lỗi: ' + error.message, false);
                document.getElementById('check-out-btn-kiosk').disabled = false;
            }
        }

        function showKioskMessage(message, success) {
            const msgEl = document.getElementById('result-message-kiosk');
            msgEl.textContent = message;
            msgEl.style.background = success ? 'linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%)' : 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';
            msgEl.style.color = success ? '#1e5631' : '#d62828';
            msgEl.style.border = success ? '2px solid #52b788' : '2px solid #f77f00';
            msgEl.style.display = 'block';

            setTimeout(() => {
                msgEl.style.display = 'none';
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            initKioskClock();
            loadKioskStatus();
        });
    </script>
</odoo>
