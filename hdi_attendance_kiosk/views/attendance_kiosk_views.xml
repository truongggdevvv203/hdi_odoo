<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        <!-- Template Kiosk Chấm Công -->
        <template id="attendance_kiosk_template" name="Attendance Kiosk">
            <t t-call="web.layout">
                <div class="attendance-kiosk-container">
                    <div class="kiosk-content">
                        <!-- Header -->
                        <div class="kiosk-header">
                            <h1 class="kiosk-title">Chấm Công Điện Tử</h1>
                            <div class="current-time" id="current-time">
                                <span class="time"></span>
                            </div>
                        </div>

                        <!-- Status Card -->
                        <div class="status-card" id="status-card">
                            <div class="employee-info">
                                <h2 id="employee-name" class="employee-name">Loading...</h2>
                                <div id="status-message" class="status-message"></div>
                            </div>

                            <!-- Status Details -->
                            <div id="status-details" class="status-details">
                                <div class="detail-item" id="check-in-item" style="display: none;">
                                    <span class="detail-label">Check-in:</span>
                                    <span class="detail-value" id="check-in-time"></span>
                                </div>
                                <div class="detail-item" id="check-out-item" style="display: none;">
                                    <span class="detail-label">Check-out:</span>
                                    <span class="detail-value" id="check-out-time"></span>
                                </div>
                                <div class="detail-item" id="worked-hours-item" style="display: none;">
                                    <span class="detail-label">Giờ làm việc:</span>
                                    <span class="detail-value" id="worked-hours-value"></span>
                                </div>
                                <div class="detail-item current-hours-item">
                                    <span class="detail-label">Hôm nay:</span>
                                    <span class="detail-value" id="current-worked-hours">0 giờ</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <button class="btn btn-check-in" id="check-in-btn" onclick="checkIn()">
                                <i class="fa fa-sign-in"></i>
                                <span>Check-in</span>
                            </button>
                            <button class="btn btn-check-out" id="check-out-btn" onclick="checkOut()" disabled>
                                <i class="fa fa-sign-out"></i>
                                <span>Check-out</span>
                            </button>
                        </div>

                        <!-- Result Message -->
                        <div id="result-message" class="result-message" style="display: none;"></div>
                    </div>
                </div>

                <script type="text/javascript">
                    // Cập nhật giờ hiện tại
                    function updateClock() {
                        const now = new Date();
                        const timeStr = now.toLocaleTimeString('vi-VN');
                        document.querySelector('.time').textContent = timeStr;
                    }
                    setInterval(updateClock, 1000);
                    updateClock();

                    // Lấy trạng thái hiện tại
                    async function getStatus() {
                        try {
                            const response = await fetch('/kiosk/api/status', {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            const data = await response.json();
                            
                            if (data.success) {
                                updateStatusUI(data);
                                updateWorkedHours();
                                
                                // Cập nhật lại trạng thái mỗi 5 giây
                                setTimeout(getStatus, 5000);
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    }

                    function updateStatusUI(status) {
                        const nameEl = document.getElementById('employee-name');
                        const messageEl = document.getElementById('status-message');
                        const checkInBtn = document.getElementById('check-in-btn');
                        const checkOutBtn = document.getElementById('check-out-btn');
                        const statusDetails = document.getElementById('status-details');
                        
                        nameEl.textContent = status.employee_name || 'Loading...';
                        messageEl.textContent = status.message || '';
                        
                        // Reset hiển thị
                        document.getElementById('check-in-item').style.display = 'none';
                        document.getElementById('check-out-item').style.display = 'none';
                        document.getElementById('worked-hours-item').style.display = 'none';
                        
                        if (status.status === 'not_checked_in') {
                            checkInBtn.disabled = false;
                            checkOutBtn.disabled = true;
                            checkInBtn.classList.add('active');
                            checkOutBtn.classList.remove('active');
                        } else if (status.status === 'checked_in') {
                            checkInBtn.disabled = true;
                            checkOutBtn.disabled = false;
                            checkInBtn.classList.remove('active');
                            checkOutBtn.classList.add('active');
                            
                            // Hiển thị check-in time
                            const checkInItem = document.getElementById('check-in-item');
                            checkInItem.style.display = 'flex';
                            document.getElementById('check-in-time').textContent = 
                                new Date(status.check_in_time).toLocaleTimeString('vi-VN');
                        } else if (status.status === 'checked_out') {
                            checkInBtn.disabled = false;
                            checkOutBtn.disabled = true;
                            checkInBtn.classList.add('active');
                            checkOutBtn.classList.remove('active');
                            
                            // Hiển thị check-in/out times và giờ làm
                            document.getElementById('check-in-item').style.display = 'flex';
                            document.getElementById('check-out-item').style.display = 'flex';
                            document.getElementById('worked-hours-item').style.display = 'flex';
                            
                            document.getElementById('check-in-time').textContent = 
                                new Date(status.check_in_time).toLocaleTimeString('vi-VN');
                            document.getElementById('check-out-time').textContent = 
                                new Date(status.check_out_time).toLocaleTimeString('vi-VN');
                            document.getElementById('worked-hours-value').textContent = 
                                status.worked_hours + ' giờ';
                        }
                    }

                    async function updateWorkedHours() {
                        try {
                            const response = await fetch('/kiosk/api/today-worked-hours', {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            });
                            const data = await response.json();
                            
                            if (data.success) {
                                const hours = data.total_worked_hours;
                                document.getElementById('current-worked-hours').textContent = 
                                    hours.toFixed(1) + ' giờ';
                            }
                        } catch (error) {
                            console.error('Error:', error);
                        }
                    }

                    async function checkIn() {
                        try {
                            const btn = document.getElementById('check-in-btn');
                            btn.disabled = true;
                            
                            const payload = {};
                            
                            // Thử lấy GPS nếu có
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(
                                    (position) => {
                                        payload.in_latitude = position.coords.latitude;
                                        payload.in_longitude = position.coords.longitude;
                                        sendCheckIn(payload, btn);
                                    },
                                    () => {
                                        sendCheckIn(payload, btn);
                                    }
                                );
                            } else {
                                sendCheckIn(payload, btn);
                            }
                        } catch (error) {
                            showResultMessage('Lỗi: ' + error.message, false);
                            document.getElementById('check-in-btn').disabled = false;
                        }
                    }

                    async function sendCheckIn(payload, btn) {
                        try {
                            const response = await fetch('/kiosk/api/check-in', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(payload)
                            });
                            
                            const data = await response.json();
                            showResultMessage(data.message, data.success);
                            
                            if (data.success) {
                                setTimeout(getStatus, 500);
                            } else {
                                btn.disabled = false;
                            }
                        } catch (error) {
                            showResultMessage('Lỗi: ' + error.message, false);
                            btn.disabled = false;
                        }
                    }

                    async function checkOut() {
                        try {
                            const btn = document.getElementById('check-out-btn');
                            btn.disabled = true;
                            
                            const payload = {};
                            
                            // Thử lấy GPS nếu có
                            if (navigator.geolocation) {
                                navigator.geolocation.getCurrentPosition(
                                    (position) => {
                                        payload.out_latitude = position.coords.latitude;
                                        payload.out_longitude = position.coords.longitude;
                                        sendCheckOut(payload, btn);
                                    },
                                    () => {
                                        sendCheckOut(payload, btn);
                                    }
                                );
                            } else {
                                sendCheckOut(payload, btn);
                            }
                        } catch (error) {
                            showResultMessage('Lỗi: ' + error.message, false);
                            document.getElementById('check-out-btn').disabled = false;
                        }
                    }

                    async function sendCheckOut(payload, btn) {
                        try {
                            const response = await fetch('/kiosk/api/check-out', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify(payload)
                            });
                            
                            const data = await response.json();
                            showResultMessage(data.message, data.success);
                            
                            if (data.success) {
                                setTimeout(getStatus, 500);
                            } else {
                                btn.disabled = false;
                            }
                        } catch (error) {
                            showResultMessage('Lỗi: ' + error.message, false);
                            btn.disabled = false;
                        }
                    }

                    function showResultMessage(message, success) {
                        const msgEl = document.getElementById('result-message');
                        msgEl.textContent = message;
                        msgEl.className = 'result-message ' + (success ? 'success' : 'error');
                        msgEl.style.display = 'block';
                        
                        setTimeout(() => {
                            msgEl.style.display = 'none';
                        }, 3000);
                    }

                    // Load status khi trang tải
                    document.addEventListener('DOMContentLoaded', getStatus);
                </script>
            </t>
        </template>
    </data>
</odoo>
