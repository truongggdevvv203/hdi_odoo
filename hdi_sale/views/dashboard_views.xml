<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <!-- Dashboard View -->
  <record id="view_shipping_order_dashboard_form" model="ir.ui.view">
    <field name="name">shipping.order.dashboard.form</field>
    <field name="model">shipping.order.dashboard</field>
    <field name="arch" type="xml">
      <form string="HDI Express - Trang ch·ªß">
        <header>
          <button name="action_refresh_dashboard" string="üîÑ L√†m m·ªõi" type="object"
            class="btn-primary"/>
        </header>
        <sheet style="background: #f8f9fa;">
          <!-- Header Title -->
          <div class="row mb-4">
            <div class="col-12">
              <h2 style="color: #ff6600; font-weight: bold; margin-bottom: 5px;">
                <i class="fa fa-tachometer-alt"/>
                HDI Express Dashboard
              </h2>
              <p class="text-muted">B√°o c√°o th·ªëng k√™</p>
            </div>
          </div>

          <!-- Top Statistics Cards -->
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <i class="fa fa-boxes fa-2x"/>
                  </div>
                  <div>
                    <h3 class="mb-0">
                      <field name="total_orders"/>
                    </h3>
                    <small>T·ªïng ƒë∆°n h√†ng</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <i class="fa fa-check-circle fa-2x"/>
                  </div>
                  <div>
                    <h3 class="mb-0">
                      <field name="delivered_orders"/>
                    </h3>
                    <small>Ph√°t th√†nh c√¥ng</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px;">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <i class="fa fa-truck fa-2x"/>
                  </div>
                  <div>
                    <h3 class="mb-0">
                      <field name="pending_orders"/>
                    </h3>
                    <small>ƒêang v·∫≠n chuy·ªÉn</small>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card border-0 shadow-sm" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px; border-radius: 10px;">
                <div class="d-flex align-items-center">
                  <div class="me-3">
                    <i class="fa fa-percentage fa-2x"/>
                  </div>
                  <div>
                    <h3 class="mb-0"><field name="success_rate" digits="[16,1]"/>%
                    </h3>
                    <small>T·ª∑ l·ªá th√†nh c√¥ng</small>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Charts Section -->
          <div class="row mb-4">
            <!-- Pie Chart -->
            <div class="col-md-6">
              <div class="card border-0 shadow-sm" style="padding: 20px; border-radius: 10px;">
                <h5 class="card-title mb-3">
                  <i class="fa fa-chart-pie text-primary"/>
                  Th·ªëng k√™ ƒë∆°n h√†ng theo tr·∫°ng th√°i
                </h5>
                <div id="pieChart" style="height: 300px;"></div>
                <field name="chart_data" invisible="1"/>
              </div>
            </div>

            <!-- Detailed Statistics -->
            <div class="col-md-6">
              <div class="card border-0 shadow-sm" style="padding: 20px; border-radius: 10px;">
                <h5 class="card-title mb-3">
                  <i class="fa fa-list text-success"/>
                  Th·ªëng k√™ chi ti·∫øt
                </h5>
                <div class="list-group list-group-flush">
                  <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                    <span><i class="fa fa-clock text-warning me-2"/>Ch·ªù l·∫•y h√†ng
                    </span>
                    <span class="badge bg-warning rounded-pill">
                      <field name="waiting_pickup_orders"/>
                    </span>
                  </div>
                  <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                    <span><i class="fa fa-shipping-fast text-info me-2"/>ƒêang v·∫≠n chuy·ªÉn
                    </span>
                    <span class="badge bg-info rounded-pill">
                      <field name="in_transit_orders"/>
                    </span>
                  </div>
                  <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                    <span><i class="fa fa-redo text-secondary me-2"/>ƒê∆°n ho√†n
                    </span>
                    <span class="badge bg-secondary rounded-pill">
                      <field name="return_orders"/>
                    </span>
                  </div>
                  <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                    <span><i class="fa fa-arrow-right text-primary me-2"/>Ph√°t ti·∫øp
                    </span>
                    <span class="badge bg-primary rounded-pill">
                      <field name="forwarded_orders"/>
                    </span>
                  </div>
                  <div class="list-group-item d-flex justify-content-between align-items-center border-0 px-0">
                    <span><i class="fa fa-times-circle text-danger me-2"/>ƒê√£ h·ªßy
                    </span>
                    <span class="badge bg-danger rounded-pill">
                      <field name="cancelled_orders"/>
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </sheet>

        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script type="text/javascript">
          (function() {
            function initDashboard() {
              try {
                var chartDataField = document.querySelector('field[name="chart_data"] input') ||
                                    document.querySelector('span[name="chart_data"]');
                if (!chartDataField) {
                  console.log('Chart data field not found');
                  return;
                }

                var chartDataText = chartDataField.textContent || chartDataField.value || '{"pie_data": [], "total": 0}';
                var chartData = JSON.parse(chartDataText);

                var ctx = document.getElementById('pieChart');
                if (ctx &amp;&amp; chartData.pie_data &amp;&amp; chartData.pie_data.length > 0) {
                  ctx.innerHTML = '<canvas id="pieChartCanvas" width="300" height="300"></canvas>';
                  var canvas = document.getElementById('pieChartCanvas');

                  if (canvas &amp;&amp; typeof Chart !== 'undefined') {
                    new Chart(canvas, {
                      type: 'doughnut',
                      data: {
                        labels: chartData.pie_data.map(function(item) { return item.label; }),
                        datasets: [{
                          data: chartData.pie_data.map(function(item) { return item.value; }),
                          backgroundColor: chartData.pie_data.map(function(item) { return item.color; }),
                          borderWidth: 2,
                          borderColor: '#fff'
                        }]
                      },
                      options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                          legend: {
                            position: 'bottom',
                            labels: {
                              padding: 20,
                              usePointStyle: true
                            }
                          }
                        }
                      }
                    });
                  }
                }
              } catch (error) {
                console.error('Error initializing dashboard:', error);
              }
            }

            setTimeout(initDashboard, 1000);

            setInterval(function() {
              var refreshBtn = document.querySelector('button[name="action_refresh_dashboard"]');
              if (refreshBtn) {
                refreshBtn.click();
                setTimeout(initDashboard, 500);
              }
            }, 30000);
          })();
        </script>
      </form>
    </field>
  </record>

  <!-- Action cho Dashboard -->
  <record id="action_shipping_order_dashboard" model="ir.actions.act_window">
    <field name="name">B·∫£ng ƒêi·ªÅu Khi·ªÉn</field>
    <field name="res_model">shipping.order.dashboard</field>
    <field name="view_mode">form</field>
    <field name="view_id" ref="view_shipping_order_dashboard_form"/>
    <field name="target">current</field>
  </record>
</odoo>